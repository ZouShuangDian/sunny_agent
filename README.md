# Sunny Agent (AIæ™ºèƒ½ä½“æ¡†æ¶)

Sunny Agent æ˜¯ä¸€ä¸ªåŸºäº Python å’Œ FastAPI æ„å»ºçš„ä¼ä¸šçº§ AI æ™ºèƒ½ä½“æ¡†æ¶ã€‚å®ƒå…·å¤‡æ„å›¾è¯†åˆ«ã€æ™ºèƒ½è·¯ç”±ã€å·¥å…·è°ƒç”¨ã€RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ä»¥åŠå®Œå–„çš„å¯è§‚æµ‹æ€§ï¼ˆMetrics & Auditï¼‰åŠŸèƒ½ã€‚

## ğŸš€ é¡¹ç›®ç°çŠ¶ä¸æ ¸å¿ƒåŠŸèƒ½

å½“å‰ç‰ˆæœ¬å·²åŒ…å«ä»¥ä¸‹æ ¸å¿ƒæ¨¡å—ï¼š

- **æ™ºèƒ½æ„å›¾è·¯ç”± (Intent Engine)**:
  - åŸºäºç‰¹å¾çš„å†³ç­–æŒ‡å—ï¼Œè‡ªåŠ¨å°†è¯·æ±‚è·¯ç”±è‡³ `direct_response` (ç›´æ¥å›ç­”), `fast_track` (å¿«é€Ÿé€šé“), æˆ– `deep_engine` (æ·±åº¦å¼•æ“)ã€‚
  - æ”¯æŒå¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ç†è§£ä¸æ„å›¾æ¾„æ¸…ã€‚
- **å·¥å…·ç”Ÿæ€ç³»ç»Ÿ (Tool System)**:
  - `builtin_tools`: å†…ç½® WebSearch (åšæŸ¥) å’Œ WebFetch ç­‰åŸºç¡€å·¥å…·ã€‚
  - `ToolRegistry`: å¯æ‰©å±•çš„å·¥å…·æ³¨å†Œä¸ç®¡ç†æœºåˆ¶ã€‚
- **L1 Master Agent æ¶æ„**:
  - èŒè´£åˆ†ç¦»ï¼šæ„å›¾è¯†åˆ«ä¸å‚æ•°å½’ä¸€åŒ–è§£è€¦ã€‚
  - å‰¥ç¦»äº†ç è¡¨æŸ¥è¯¢é€»è¾‘ï¼Œä¿æŒ Master Layer çš„çº¯ç²¹æ€§ã€‚
- **æ•°æ®ä¸å­˜å‚¨**:
  - **PostgreSQL**: å­˜å‚¨ç”¨æˆ·ã€ä¼šè¯ã€å®¡è®¡æ—¥å¿— (Audit Log)ã€Prompt æ¨¡æ¿ã€‚
  - **Milvus**: å‘é‡æ•°æ®åº“ï¼Œç”¨äºçŸ¥è¯†åº“æ£€ç´¢ã€‚
  - **Redis**: ç¼“å­˜ä¸ä¼šè¯çŠ¶æ€ç®¡ç†ã€‚
- **å¯è§‚æµ‹æ€§**:
  - é›†æˆ Prometheus Metrics (æ¥å£è°ƒç”¨æ¬¡æ•°ã€è€—æ—¶ã€Token æ¶ˆè€—)ã€‚
  - ç»“æ„åŒ–å®¡è®¡æ—¥å¿—ï¼Œæ”¯æŒ Prompt æ•ˆæœè¿½è¸ª (Template ID å…³è”)ã€‚

## ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡

ç¡®ä¿æœ¬åœ°ç¯å¢ƒå·²å®‰è£…ï¼š
- Python >= 3.10
- PostgreSQL
- Redis
- Milvus (å¯é€‰ï¼Œè§†é…ç½®è€Œå®š)

## ğŸ“¦ åˆå§‹åŒ–æŒ‡å—

### 1. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/ZouShuangDian/sunny_agent.git
cd sunny_agent
```

### 2. å®‰è£…ä¾èµ–
æœ¬é¡¹ç›®ä½¿ç”¨ `poetry` è¿›è¡Œä¾èµ–ç®¡ç†ã€‚

```bash
# å®‰è£… poetry (å¦‚æœå°šæœªå®‰è£…)
pip install poetry

# å®‰è£…é¡¹ç›®ä¾èµ–
poetry install
```

### 3. é…ç½®æ–‡ä»¶
å¤åˆ¶ç¤ºä¾‹é…ç½®æ–‡ä»¶å¹¶æ ¹æ®æœ¬åœ°ç¯å¢ƒè¿›è¡Œä¿®æ”¹ã€‚

```bash
cp app/.env.example app/.env
```
è¯·ç¼–è¾‘ `app/.env` æ–‡ä»¶ï¼Œå¡«å…¥æ­£ç¡®çš„æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€API Key ç­‰ï¼š
- `DATABASE_URL`: PostgreSQL è¿æ¥ä¸²
- `REDIS_URL`: Redis è¿æ¥ä¸²
- `LLM_API_KEY`: å¤§æ¨¡å‹ API Key
- `BOCHA_API_KEY`: æœç´¢å·¥å…· API Key

### 4. æ•°æ®åº“åˆå§‹åŒ– (Alembic)
æœ¬é¡¹ç›®ä½¿ç”¨ Alembic è¿›è¡Œæ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶ã€‚**è¿™æ˜¯å¯åŠ¨å‰çš„å¿…åšæ­¥éª¤**ã€‚

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ (å¯é€‰ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨ poetry run åˆ™ä¸éœ€è¦)
poetry shell

# æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ŒåŒæ­¥è¡¨ç»“æ„åˆ°æ•°æ®åº“
alembic upgrade head
```

## ğŸš¦ å¯åŠ¨é¡¹ç›®

ä½¿ç”¨ `uvicorn` å¯åŠ¨ FastAPI æœåŠ¡ï¼š

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ
poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```
æˆ–è€…ï¼Œå¦‚æœä½ é…ç½®äº† `APP_PORT` ç¯å¢ƒå˜é‡ï¼ˆé»˜è®¤ä¸º 8000ï¼‰ï¼š
```bash
python -m uvicorn app.main:app --host 0.0.0.0
```

æœåŠ¡å¯åŠ¨åï¼š
- **Swagger æ–‡æ¡£**: [http://localhost:8000/docs](http://localhost:8000/docs)
- **Metrics ç›‘æ§**: [http://localhost:8000/metrics](http://localhost:8000/metrics)

## ğŸ—„ï¸ æ•°æ®åº“è¿ç§»å¸¸ç”¨å‘½ä»¤ (Alembic)

å½“ä¿®æ”¹äº† `app/db/models` ä¸‹çš„æ¨¡å‹å®šä¹‰åï¼Œéœ€è¦ç”Ÿæˆå¹¶æ‰§è¡Œè¿ç§»è„šæœ¬ã€‚

### ç”Ÿæˆè¿ç§»è„šæœ¬
```bash
# -m åé¢è·Ÿæ³¨é‡Šï¼Œæè¿°æœ¬æ¬¡ä¿®æ”¹çš„å†…å®¹
alembic revision --autogenerate -m "æè¿°ä½ çš„ä¿®æ”¹å†…å®¹"
```
*æ³¨æ„ï¼šç”Ÿæˆçš„è„šæœ¬ä½äº `app/db/migrations/versions/` ç›®å½•ä¸‹ï¼Œå»ºè®®æ£€æŸ¥ç”Ÿæˆçš„ä»£ç æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚*

### æ‰§è¡Œè¿ç§» (ç”Ÿæ•ˆ)
```bash
# å°†æ•°æ®åº“å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
alembic upgrade head
```

### å›æ»šè¿ç§»
```bash
# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
alembic downgrade -1
```

## ğŸ“‚ ç›®å½•ç»“æ„æ‘˜è¦
```
.
â”œâ”€â”€ alembic.ini              # Alembic é…ç½®æ–‡ä»¶
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py              # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ config.py            # é…ç½®åŠ è½½
â”‚   â”œâ”€â”€ db/                  # æ•°æ®åº“ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ migrations/      # è¿ç§»è„šæœ¬ç›®å½•
â”‚   â”‚   â””â”€â”€ models/          # ORM æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ intent/              # æ„å›¾è¯†åˆ«å¼•æ“
â”‚   â”œâ”€â”€ execution/           # æ‰§è¡Œè·¯ç”±ä¸é€»è¾‘
â”‚   â”œâ”€â”€ tools/               # å·¥å…·é›† (builtin_tools)
â”‚   â”œâ”€â”€ observability/       # ç›‘æ§ä¸æ—¥å¿—
â”‚   â””â”€â”€ services/            # ä¸šåŠ¡æœåŠ¡å±‚
â””â”€â”€ pyproject.toml           # é¡¹ç›®ä¾èµ–å®šä¹‰
```
